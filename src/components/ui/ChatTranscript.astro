---
import { parseTranscript } from '~/utils/chatTranscriptParser';
import type { ChatMessage } from '~/utils/chatTranscriptParser';

export interface Props {
  transcript?: string;
  messages?: ChatMessage[];
  theme?: 'adium' | 'minimal' | 'modern' | 'compact';
  showTimestamps?: boolean;
  showAvatars?: boolean;
  showSource?: boolean;
  collapsible?: boolean;
  maxHeight?: string;
  class?: string;
}

const {
  transcript,
  messages: propMessages,
  theme = 'adium',
  showTimestamps = false,
  showAvatars = true,
  showSource = true,
  collapsible = false,
  maxHeight,
  class: className = '',
} = Astro.props;

// Parse transcript if provided, otherwise use messages prop
const messages = transcript ? parseTranscript(transcript) : (propMessages || []);

// Extract source info if available
const sourceInfo = messages.length > 0 && messages[0].metadata?.exportInfo;

// Theme-specific classes
const themeClasses = {
  adium: {
    container: 'bg-white dark:bg-gray-900 rounded-lg overflow-hidden shadow-lg',
    titleBar: 'bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-700 px-4 py-2 border-b border-gray-300 dark:border-gray-600',
    messagesContainer: 'bg-white dark:bg-gray-950',
    messageWrapper: 'flex gap-3 border-b border-gray-100 dark:border-gray-800',
    userMessage: 'bg-white dark:bg-gray-900',
    assistantMessage: 'bg-yellow-50 dark:bg-yellow-950/20',
    messagePadding: 'px-4 py-3',
    avatar: 'w-10 h-10 flex items-center justify-center flex-shrink-0',
    userAvatar: '',
    assistantAvatar: '',
    messageContent: 'flex-1 min-w-0',
    timestamp: 'text-xs text-gray-500 dark:text-gray-400 mt-1',
  },
  minimal: {
    container: 'bg-white dark:bg-gray-900 rounded-lg p-4',
    messageWrapper: 'mb-4',
    userBubble: 'font-medium text-gray-900 dark:text-gray-100',
    assistantBubble: 'text-gray-700 dark:text-gray-300',
    avatar: 'hidden',
    userAvatar: '',
    assistantAvatar: '',
    timestamp: 'text-xs text-gray-400 dark:text-gray-500',
  },
  modern: {
    container: 'bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 rounded-xl p-6',
    messageWrapper: 'flex gap-4 mb-6',
    userBubble: 'bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl px-5 py-3 max-w-[75%] shadow-md',
    assistantBubble: 'bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-xl px-5 py-3 max-w-[75%] shadow-md',
    avatar: 'w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold',
    userAvatar: 'bg-gradient-to-br from-blue-500 to-blue-700',
    assistantAvatar: 'bg-gradient-to-br from-gray-500 to-gray-700',
    timestamp: 'text-xs text-gray-500 dark:text-gray-400 mt-2',
  },
  compact: {
    container: 'bg-white dark:bg-gray-900 rounded p-2',
    messageWrapper: 'mb-2',
    userBubble: 'text-sm font-medium text-blue-700 dark:text-blue-400',
    assistantBubble: 'text-sm text-gray-700 dark:text-gray-300',
    avatar: 'hidden',
    userAvatar: '',
    assistantAvatar: '',
    timestamp: 'text-xs text-gray-400 dark:text-gray-500',
  },
};

const currentTheme = themeClasses[theme];

// Container styles with optional max height for scrolling
const containerStyle = maxHeight ? `max-height: ${maxHeight}; overflow-y: auto;` : '';

// Simple markdown to HTML converter for chat messages
function renderMarkdown(text: string): string {
  if (!text) return '';
  
  // First, temporarily replace code blocks to protect them
  const codeBlocks: string[] = [];
  let protectedText = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
    const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
    const trimmedCode = code.trim();
    // Escape HTML in code blocks
    const escapedCode = trimmedCode
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
    codeBlocks.push(`<pre class="language-${lang || 'plaintext'}"><code>${escapedCode}</code></pre>`);
    return placeholder;
  });

  // Also protect inline code
  const inlineCode: string[] = [];
  protectedText = protectedText.replace(/`([^`]+)`/g, (match, code) => {
    const placeholder = `__INLINE_CODE_${inlineCode.length}__`;
    const escapedCode = code
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
    inlineCode.push(`<code>${escapedCode}</code>`);
    return placeholder;
  });
  
  // Now process the rest of the markdown
  let html = protectedText
    // Escape remaining HTML
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    // Headers (if any)
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    // Bold (now safe from code blocks)
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    // Lists
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
    // Links
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
    // Line breaks
    .replace(/\n/g, '<br>');
  
  // Restore code blocks
  codeBlocks.forEach((block, i) => {
    html = html.replace(`__CODE_BLOCK_${i}__`, block);
  });
  
  // Restore inline code
  inlineCode.forEach((code, i) => {
    html = html.replace(`__INLINE_CODE_${i}__`, code);
  });
    
  return `<div class="message-content prose prose-sm dark:prose-invert max-w-none">${html}</div>`;
}
---

<div 
  class={`chat-transcript ${currentTheme.container} ${className}`}
  data-theme={theme}
>
  {theme === 'adium' && (
    <div class={currentTheme.titleBar}>
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-orange-500" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
        </svg>
        <span class="font-medium text-gray-700 dark:text-gray-200">
          {messages.length > 0 && messages[0].metadata?.source === 'cursor' ? 'Claude - Cursor Export' : 
           messages.length > 0 && messages[0].metadata?.source === 'claude-code' ? 'Claude Code' : 
           'Chat Transcript'}
        </span>
      </div>
      {sourceInfo && (
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          Conversation began {sourceInfo.replace('Exported on ', '').replace(' from Cursor (1.5.5)', '')}
        </div>
      )}
    </div>
  )}
  
  <div 
    class={theme === 'adium' ? currentTheme.messagesContainer : ''}
    style={containerStyle}
  >
    {messages.map((message, index) => {
      const isUser = message.role === 'user';
      
      if (theme === 'adium') {
        return (
          <div 
            class={`${currentTheme.messageWrapper} ${isUser ? currentTheme.userMessage : currentTheme.assistantMessage} ${currentTheme.messagePadding}`}
            data-role={message.role}
          >
            {showAvatars && (
              <div class={currentTheme.avatar}>
                {isUser ? (
                  <span class="text-3xl">üê∏</span>
                ) : (
                  <svg class="w-8 h-8 text-orange-500" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l10 5v10c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V7l10-5zm0 2.2L4.5 8v8.5c0 .3.2.5.5.5h14c.3 0 .5-.2.5-.5V8L12 4.2zM8 10c-.6 0-1 .4-1 1s.4 1 1 1 1-.4 1-1-.4-1-1-1zm8 0c-.6 0-1 .4-1 1s.4 1 1 1 1-.4 1-1-.4-1-1-1zm-4 3c-2.2 0-4 1.8-4 4h8c0-2.2-1.8-4-4-4z"/>
                  </svg>
                )}
              </div>
            )}
            
            <div class={currentTheme.messageContent}>
              <div class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-1">
                {isUser ? 'User' : (message.metadata?.source === 'cursor' ? 'Cursor' : 'Claude')}
              </div>
              <div 
                class="message-text"
                set:html={renderMarkdown(message.content)}
              />
              {showTimestamps && message.timestamp && (
                <div class={currentTheme.timestamp}>
                  {message.timestamp}
                </div>
              )}
            </div>
          </div>
        );
      } else {
        // Original bubble layout for other themes
        const alignClass = (isUser ? 'justify-end' : 'justify-start');
        
        return (
          <div 
            class={`message ${currentTheme.messageWrapper} ${alignClass}`}
            data-role={message.role}
          >
            {showAvatars && theme !== 'minimal' && theme !== 'compact' && !isUser && (
              <div class={`${currentTheme.avatar} ${currentTheme.assistantAvatar}`}>
                A
              </div>
            )}
            
            <div class={isUser ? 'flex flex-col items-end' : ''}>
              <div 
                class={`message-bubble ${isUser ? currentTheme.userBubble : currentTheme.assistantBubble}`}
                set:html={renderMarkdown(message.content)}
              />
              
              {showTimestamps && message.timestamp && (
                <div class={currentTheme.timestamp}>
                  {message.timestamp}
                </div>
              )}
            </div>
            
            {showAvatars && theme !== 'minimal' && theme !== 'compact' && isUser && (
              <div class={`${currentTheme.avatar} ${currentTheme.userAvatar}`}>
                U
              </div>
            )}
          </div>
        );
      }
    })}
  </div>
</div>

<style>
  .chat-transcript {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  }

  .message-content {
    white-space: pre-wrap;
    word-break: break-word;
  }

  .message-content code {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }

  .dark .message-content code {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .message-content pre {
    background-color: #1e293b;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 0.5rem 0;
  }

  .message-content pre code {
    background-color: transparent;
    padding: 0;
  }

  /* Adium-specific styling */
  [data-theme="adium"] {
    border: 1px solid #e5e7eb;
  }

  [data-theme="adium"] .message-text {
    color: #374151;
  }

  .dark [data-theme="adium"] {
    border: 1px solid #374151;
  }

  .dark [data-theme="adium"] .message-text {
    color: #e5e7eb;
  }

  [data-theme="adium"] .message-text pre {
    background-color: #f3f4f6;
    border: 1px solid #e5e7eb;
  }

  .dark [data-theme="adium"] .message-text pre {
    background-color: #1f2937;
    border: 1px solid #374151;
  }

  /* Smooth scrolling for container */
  .chat-transcript[style*="max-height"] {
    scroll-behavior: smooth;
    scrollbar-width: thin;
  }

  .chat-transcript[style*="max-height"]::-webkit-scrollbar {
    width: 6px;
  }

  .chat-transcript[style*="max-height"]::-webkit-scrollbar-track {
    background: transparent;
  }

  .chat-transcript[style*="max-height"]::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }

  .dark .chat-transcript[style*="max-height"]::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
  }
</style>

<script>
  // Add copy button to code blocks
  document.addEventListener('DOMContentLoaded', () => {
    const codeBlocks = document.querySelectorAll('.chat-transcript pre');
    
    codeBlocks.forEach((block) => {
      const button = document.createElement('button');
      button.className = 'copy-code-btn';
      button.textContent = 'Copy';
      button.style.cssText = `
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.25rem 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 0.25rem;
        color: #e2e8f0;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
      `;
      
      block.style.position = 'relative';
      block.appendChild(button);
      
      button.addEventListener('click', async () => {
        const code = block.querySelector('code')?.textContent || block.textContent;
        await navigator.clipboard.writeText(code);
        button.textContent = 'Copied!';
        setTimeout(() => {
          button.textContent = 'Copy';
        }, 2000);
      });
    });
  });

  // Handle collapsible messages if enabled
  const collapsibleElements = document.querySelectorAll('.chat-transcript[data-collapsible="true"] .message-content');
  collapsibleElements.forEach((element) => {
    if (element.scrollHeight > 200) {
      element.style.maxHeight = '200px';
      element.style.overflow = 'hidden';
      element.style.cursor = 'pointer';
      element.style.position = 'relative';
      
      const expandBtn = document.createElement('div');
      expandBtn.textContent = 'Show more...';
      expandBtn.style.cssText = `
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        background: linear-gradient(transparent, currentColor);
        text-align: center;
        cursor: pointer;
      `;
      
      element.appendChild(expandBtn);
      
      element.addEventListener('click', () => {
        if (element.style.maxHeight === '200px') {
          element.style.maxHeight = 'none';
          expandBtn.textContent = 'Show less';
        } else {
          element.style.maxHeight = '200px';
          expandBtn.textContent = 'Show more...';
        }
      });
    }
  });
</script>