---
import Layout from '~/layouts/PageLayout.astro';

const metadata = {
  title: 'Search',
  description: 'Search through all blog posts, insights, and commentary',
  pagefind: false,
};
---

<Layout metadata={metadata}>
  <section class="px-4 py-16 mx-auto max-w-6xl lg:px-8 lg:py-20">
    <div class="max-w-3xl mx-auto text-center pb-10 md:pb-16">
      <h1 class="text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-4 font-heading dark:text-gray-200">
        Search
      </h1>
      <p class="text-xl text-muted dark:text-slate-400">
        Search through all blog posts, insights, and commentary on AI and technology leadership
      </p>
    </div>
    
    <div class="max-w-4xl mx-auto">
      <div id="search" class="w-full"></div>
    </div>
  </section>
</Layout>

<script>
  import { PagefindUI } from '@pagefind/default-ui';
  
  // Initialize Pagefind UI when the page loads
  window.addEventListener('DOMContentLoaded', () => {
    new PagefindUI({ 
      element: "#search", 
      showSubResults: true,
      showImages: false,
      excerptLength: 30
    });
    
    // Fix trailing slash URLs in search results using MutationObserver
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === Node.ELEMENT_NODE) {
            // Fix links in the added content
            const links = node.querySelectorAll ? node.querySelectorAll('a[href]') : [];
            links.forEach(fixTrailingSlash);
            
            // Also fix if the node itself is a link
            if (node.tagName === 'A' && node.href) {
              fixTrailingSlash(node);
            }
          }
        });
      });
    });
    
    function fixTrailingSlash(link) {
      if (link.href && link.href.includes(window.location.hostname)) {
        const url = new URL(link.href);
        if (url.pathname.endsWith('/') && url.pathname !== '/') {
          const newPath = url.pathname.replace(/\/$/, '');
          link.href = url.origin + newPath + url.search + url.hash;
        }
      }
    }
    
    // Start observing
    observer.observe(document.getElementById('search'), {
      childList: true,
      subtree: true
    });
    
    // Also fix any existing links after a short delay to catch initial results
    setTimeout(() => {
      document.querySelectorAll('#search a[href]').forEach(fixTrailingSlash);
    }, 100);
  });
</script>

<style>
  /* Custom styles for Pagefind to match AstroWind theme */
  :global(.pagefind-ui) {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #3b82f6;
    --pagefind-ui-text: #1f2937;
    --pagefind-ui-background: #ffffff;
    --pagefind-ui-border: #d1d5db;
    --pagefind-ui-tag: #f3f4f6;
  }

  :global(.dark .pagefind-ui) {
    --pagefind-ui-text: #f9fafb;
    --pagefind-ui-background: #1f2937;
    --pagefind-ui-border: #374151;
    --pagefind-ui-tag: #374151;
  }

  :global(.pagefind-ui__search-input) {
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 1.125rem;
    color: #1f2937 !important;
    background-color: #ffffff !important;
    border: 2px solid #d1d5db !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
  }

  :global(.pagefind-ui__search-input:focus) {
    border-color: #3b82f6 !important;
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
  }

  :global(.pagefind-ui__search-input::placeholder) {
    color: #6b7280 !important;
  }

  :global(.dark .pagefind-ui__search-input) {
    color: #f9fafb !important;
    background-color: #374151 !important;
    border-color: #4b5563 !important;
  }

  :global(.dark .pagefind-ui__search-input:focus) {
    border-color: #60a5fa !important;
    box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
  }

  :global(.dark .pagefind-ui__search-input::placeholder) {
    color: #9ca3af !important;
  }

  :global(.pagefind-ui__result) {
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    padding: 1rem;
  }

  :global(.pagefind-ui__result-title) {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  :global(.pagefind-ui__button) {
    background-color: #f3f4f6 !important;
    color: #374151 !important;
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    padding: 0.5rem 1rem !important;
  }

  :global(.dark .pagefind-ui__button) {
    background-color: #4b5563 !important;
    color: #f9fafb !important;
    border-color: #6b7280 !important;
  }
</style>