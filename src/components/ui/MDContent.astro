---
interface Props {
  title: string;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  Content: any; // Pre-imported Content component from markdown
  description?: string;
  className?: string;
  allowFullscreen?: boolean; // Enable fullscreen toggle
}

const { title, Content, description, className = '', allowFullscreen = false } = Astro.props;
---

<section
  class={`mdcontent-container my-8 p-6 bg-gray-50/50 dark:bg-gray-800/30 rounded-xl border border-gray-200 dark:border-gray-700 transition-all duration-300 ${className}`}
  data-fullscreen-enabled={allowFullscreen}
>
  <header class="mb-6 flex items-start justify-between">
    <div class="flex-1">
      <h2
        class="text-3xl font-bold text-gray-900 dark:text-white mb-3 border-b border-gray-200 dark:border-gray-600 pb-2"
      >
        {title}
      </h2>
      {description && <p class="text-gray-600 dark:text-gray-300 text-base leading-relaxed">{description}</p>}
    </div>

    {
      allowFullscreen && (
        <button
          class="mdcontent-fullscreen-toggle ml-4 p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex-shrink-0"
          aria-label="Toggle fullscreen"
          title="Toggle fullscreen view"
        >
          {/* Expand icon (shown when not fullscreen) */}
          <svg
            class="expand-icon w-5 h-5 text-gray-700 dark:text-gray-300"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
            />
          </svg>
          {/* Collapse icon (shown when fullscreen) */}
          <svg
            class="collapse-icon w-5 h-5 text-gray-700 dark:text-gray-300 hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      )
    }
  </header>

  <div
    class="mdcontent-body overflow-y-auto prose prose-lg dark:prose-invert max-w-none
              prose-headings:text-gray-900 dark:prose-headings:text-white
              prose-p:text-gray-700 dark:prose-p:text-gray-300
              prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-a:no-underline hover:prose-a:underline
              prose-strong:text-gray-900 dark:prose-strong:text-white
              prose-code:text-pink-600 dark:prose-code:text-pink-400
              prose-pre:bg-gray-100 dark:prose-pre:bg-gray-900
              prose-blockquote:border-blue-500 prose-blockquote:bg-blue-50/50 dark:prose-blockquote:bg-blue-900/20
              prose-table:text-sm
              prose-th:bg-gray-100 dark:prose-th:bg-gray-800
              prose-td:border-gray-200 dark:prose-td:border-gray-700
              [&>*:first-child]:hidden"
  >
    <Content />
  </div>
</section>

<style>
  /* Normal mode: responsive viewport-based max-height with internal scrolling */
  .mdcontent-body {
    /* Mobile: smaller viewport, leave room for header/footer */
    max-height: 60vh;
  }

  /* Tablet and larger: more vertical space available */
  @media (min-width: 768px) {
    .mdcontent-body {
      max-height: 70vh;
    }
  }

  /* Desktop: even more space */
  @media (min-width: 1024px) {
    .mdcontent-body {
      max-height: 75vh;
    }
  }

  /* Large desktop: maximize reading area */
  @media (min-width: 1280px) {
    .mdcontent-body {
      max-height: 80vh;
    }
  }

  /* Smooth scrolling for better UX */
  .mdcontent-body {
    scroll-behavior: smooth;
  }

  /* Custom scrollbar styling for webkit browsers */
  .mdcontent-body::-webkit-scrollbar {
    width: 8px;
  }

  .mdcontent-body::-webkit-scrollbar-track {
    background: rgb(243, 244, 246); /* gray-100 */
    border-radius: 4px;
  }

  .mdcontent-body::-webkit-scrollbar-thumb {
    background: rgb(209, 213, 219); /* gray-300 */
    border-radius: 4px;
  }

  .mdcontent-body::-webkit-scrollbar-thumb:hover {
    background: rgb(156, 163, 175); /* gray-400 */
  }

  /* Dark mode scrollbar */
  :global(.dark) .mdcontent-body::-webkit-scrollbar-track {
    background: rgb(31, 41, 55); /* gray-800 */
  }

  :global(.dark) .mdcontent-body::-webkit-scrollbar-thumb {
    background: rgb(75, 85, 99); /* gray-600 */
  }

  :global(.dark) .mdcontent-body::-webkit-scrollbar-thumb:hover {
    background: rgb(107, 114, 128); /* gray-500 */
  }

  /* Fullscreen mode styles */
  .mdcontent-container.fullscreen {
    position: fixed;
    top: 1rem;
    left: 1rem;
    right: 1rem;
    bottom: 1rem;
    width: calc(100vw - 2rem);
    height: calc(100vh - 2rem);
    max-width: calc(100vw - 2rem);
    margin: 0;
    border-radius: 8px;
    z-index: 9999;
    overflow-y: auto;
    background: white;
    padding: 0 2rem 2rem 2rem; /* No top padding - header handles it */
    /* Strong border and shadow for better context */
    border: 3px solid rgb(59, 130, 246); /* blue-500 */
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  }

  .mdcontent-container.fullscreen.dark {
    background: rgb(17, 24, 39); /* gray-900 */
  }

  /* Show collapse icon when fullscreen */
  .mdcontent-container.fullscreen .expand-icon {
    display: none;
  }

  .mdcontent-container.fullscreen .collapse-icon {
    display: block;
  }

  /* Backdrop when fullscreen */
  .mdcontent-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9998;
    backdrop-filter: blur(4px);
  }

  /* Better scrolling in fullscreen - override normal mode constraints */
  .mdcontent-container.fullscreen .mdcontent-body {
    max-height: none; /* Remove viewport-based constraints in fullscreen */
    overflow-y: visible; /* Don't scroll the body itself in fullscreen */
    padding-bottom: 2rem; /* Add bottom padding for better spacing */
  }

  /* Make header sticky in fullscreen with proper background */
  .mdcontent-container.fullscreen header {
    position: sticky;
    top: 0;
    background: white;
    padding: 2rem 2rem 1.5rem 2rem; /* Top padding replaces container padding */
    margin: 0 -2rem 1.5rem -2rem; /* Negative horizontal margin to extend to edges */
    z-index: 10;
    border-bottom: 2px solid rgb(229, 231, 235); /* gray-200 - thicker for emphasis */
    border-radius: 8px 8px 0 0; /* Match container border radius */
    /* Add shadow when content scrolls behind */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .mdcontent-container.fullscreen.dark header {
    background: rgb(17, 24, 39); /* gray-900 */
    border-bottom-color: rgb(55, 65, 81); /* gray-700 */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
</style>

<script is:inline>
  // Fullscreen toggle functionality
  function initMDContentFullscreen() {
    console.log('[MDContent] Initializing fullscreen functionality');
    const containers = document.querySelectorAll('[data-fullscreen-enabled="true"]');
    console.log('[MDContent] Found containers:', containers.length);

    containers.forEach((container) => {
      const button = container.querySelector('.mdcontent-fullscreen-toggle');
      console.log('[MDContent] Button found:', !!button);
      if (!button) return;

      // Prevent double initialization
      if (button.dataset.initialized === 'true') {
        console.log('[MDContent] Already initialized, skipping');
        return;
      }
      button.dataset.initialized = 'true';

      let backdrop = null;

      const toggleFullscreen = () => {
        console.log('[MDContent] Toggle fullscreen clicked');
        const isFullscreen = container.classList.contains('fullscreen');
        console.log('[MDContent] Current fullscreen state:', isFullscreen);

        if (isFullscreen) {
          // Exit fullscreen
          container.classList.remove('fullscreen');
          container.classList.remove('dark');
          if (backdrop) {
            backdrop.remove();
            backdrop = null;
          }
          document.body.style.overflow = '';
        } else {
          // Enter fullscreen
          container.classList.add('fullscreen');

          // Match dark mode class
          if (document.documentElement.classList.contains('dark')) {
            container.classList.add('dark');
          }

          // Create backdrop (insert before container in DOM)
          backdrop = document.createElement('div');
          backdrop.className = 'mdcontent-backdrop';
          backdrop.addEventListener('click', toggleFullscreen);

          // Insert backdrop before the container
          if (container.parentNode) {
            container.parentNode.insertBefore(backdrop, container);
          }

          // Prevent body scroll
          document.body.style.overflow = 'hidden';
        }
      };

      // Button click handler
      button.addEventListener('click', (e) => {
        console.log('[MDContent] Button clicked!');
        e.preventDefault();
        e.stopPropagation();
        toggleFullscreen();
      });

      // ESC key handler
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && container.classList.contains('fullscreen')) {
          toggleFullscreen();
        }
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMDContentFullscreen);
  } else {
    initMDContentFullscreen();
  }

  // Reinitialize on Astro page transitions
  document.addEventListener('astro:page-load', initMDContentFullscreen);
</script>
